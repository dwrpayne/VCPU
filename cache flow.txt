Cacheable:
	Read: is valid and tag maches?
		yes: set valid, return value
		no: readmiss.
			send read addr and request to bus
			stall for ack
			when read response, write whole line to cache.
			set dirty = false
			return value
	Write: is valid 
		yes
			does tag match?	
				yes
					write wordmask value to cache
					write tag
					set valid
					set dirty cache line
				no	
					is dirty?
						yes
							evict!
							send write request on the calculated tag address
							stall for ack
							wait many cycles for a response
							when response arrives, now GOTO write not valid
						no
							GOTO write not valid
		no
			GOSUB readmiss and return here
			after read response, write the partial byte to the cache line
Uncacheable:
	Read:
		Send read request
		stall
		upon response, store result in a buffer, return it 
	Write:
		Send write request
		stall for ack

		
States (set on last update, to recognize at start of my update)
	idle
	waiting for memory read
	waiting for memory write
	
	can distinguish readmiss from write miss because I'll have the write signal on my input still
	
	
cache controller owns cache and buffer
	
	flow:
		pass to cache:
			tag
			line mask (256) (all 1s iff line write, otherwise partial write)	(line from mem + word write is premasked!)
			line data (256) (the whole line's data to be masked into the reg) 
			enable
				set dirty to 1 if the line mask has some but not all 1s, set dirty to 0 if the line mask is all 1s. leave alone if all 0s.		
		expect back
			valid
			tag matched
			dirty
			data word
			data line
			tag (for evicted address computation)
			
cache is simplified
	takes 
		
	
		
		
WITH WRITE BUFFER
		
Cacheable:
	Read: is valid and tag maches?
		yes: set valid, return value
		no: 
			does read addr exist in write buffer?
				yes
					return the value from the buffer						
				no
					readmiss.
					send read addr and request to bus
					stall for ack
					when read response, write whole line to cache.
					set dirty = false
					return value
	Write: is valid
		yes
			does tag match?	
				yes
					write wordmask value to cache
					write tag
					set valid
					set dirty cache line
				no	
					is dirty?
						yes
							evict!
							is write buffer full? 
								yes
									stall until write buffer isn't full	
									GOTO no
								no
									buffer a write request on the calculated tag address
							GOTO write not valid
						no
							GOTO write not valid
		no
			GOSUB readmiss and return here
			after read response, write the partial byte to the cache line
			
Uncacheable:
	Read:
		Send read request
		stall
		upon response, store result in a buffer, return it 
	Write:
		Send write request to buffer
				